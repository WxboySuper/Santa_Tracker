name: Deploy on release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROD_DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
      PROD_DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
      PROD_DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
      PROD_DOTENV: ${{ secrets.PROD_DOTENV }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare deployment package
        run: |
          set -euo pipefail
          rm -rf deployment-package
          mkdir -p deployment-package
          # copy repo files into a clean directory (exclude git and workflow files)
          rsync -a --exclude='.git' --exclude='.github' --exclude='deployment-package' ./ deployment-package/

      - name: Load SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Verify remote sudo wrappers available (fail early if sudo would prompt)
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST} "sudo -l"

      - name: Upload files and finalize deploy on remote host
        env:
          PROD_DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
          PROD_DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
          PROD_DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
          PROD_DOTENV: ${{ secrets.PROD_DOTENV }}
        run: |
          set -euo pipefail

          RELEASE_ROOT="${PROD_DEPLOY_PATH}/releases"
          TIMESTAMP="$(date -u +%Y%m%d-%H%M%S)"
          REMOTE_DIR="${RELEASE_ROOT}/${TIMESTAMP}"

          echo "Creating remote release dir: ${REMOTE_DIR}"
          ssh -o StrictHostKeyChecking=no ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST} "mkdir -p '${REMOTE_DIR}'"

          echo "Uploading files to ${REMOTE_DIR}"
          rsync -az --delete -e "ssh -o StrictHostKeyChecking=no" deployment-package/ ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST}:"${REMOTE_DIR}/"

          echo "Running remote finalize (wrappers must exist on server)"
          ssh -o StrictHostKeyChecking=no ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST} "PROD_DEPLOY_PATH='${PROD_DEPLOY_PATH}' PROD_DEPLOY_USER='${PROD_DEPLOY_USER}' REMOTE_DIR='${REMOTE_DIR}' RELEASE_ROOT='${RELEASE_ROOT}' PROD_DOTENV='${PROD_DOTENV}' bash -s" <<'REMOTE_EOF'
            set -euo pipefail

            # create venv and install requirements (best-effort)
            python3 -m venv "${REMOTE_DIR}/venv" || true
            "${REMOTE_DIR}/venv/bin/pip" install --upgrade pip setuptools wheel || true
            if [ -f "${REMOTE_DIR}/requirements.txt" ]; then
              "${REMOTE_DIR}/venv/bin/pip" install -r "${REMOTE_DIR}/requirements.txt" || true
            fi

            # run migrations if present (with .env if provided)
            if [ -f "${REMOTE_DIR}/alembic.ini" ]; then
              if [ -f "${REMOTE_DIR}/.env" ]; then
                set -o allexport; source "${REMOTE_DIR}/.env"; set +o allexport
              fi
              cd "${REMOTE_DIR}" && ./venv/bin/alembic upgrade head || true
            fi

            # write .env from runner secret into the release dir (create/overwrite if provided)
            if [ -n "${PROD_DOTENV:-}" ]; then
              printf '%s\n' "${PROD_DOTENV}" > "${REMOTE_DIR}/.env"
            fi

            # secure .env via root-owned wrapper scripts
            if [ -f "${REMOTE_DIR}/.env" ]; then
              sudo -n /usr/local/bin/deploy_chown.sh "${PROD_DEPLOY_USER}:${PROD_DEPLOY_USER}" "${REMOTE_DIR}/.env" || true
              sudo -n /usr/local/bin/deploy_chmod.sh 600 "${REMOTE_DIR}/.env" || true
            fi

            # update current symlink (via wrapper) and ensure ownership
            sudo -n /usr/local/bin/deploy_ln.sh "${REMOTE_DIR}" "${PROD_DEPLOY_PATH}/current" || true
            sudo -n /usr/local/bin/deploy_chown.sh "${PROD_DEPLOY_USER}:${PROD_DEPLOY_USER}" "${REMOTE_DIR}" || true

            # ensure data ownership
            sudo -n /usr/local/bin/deploy_chown.sh "${PROD_DEPLOY_USER}:${PROD_DEPLOY_USER}" "${PROD_DEPLOY_PATH}/data" || true

            # ensure releases ownership before attempting cleanup
            sudo -n /usr/local/bin/deploy_chown.sh "${PROD_DEPLOY_USER}:${PROD_DEPLOY_USER}" "${RELEASE_ROOT}" || true
            cd "${RELEASE_ROOT}" || exit 0
            ls -1dt * 2>/dev/null | tail -n +6 | xargs -r rm -rf || true

            # reload and restart service via safe wrapper
            sudo -n /usr/local/bin/deploy_systemctl.sh daemon-reload santa-tracker || true
            sudo -n /usr/local/bin/deploy_systemctl.sh restart santa-tracker || true

            echo "Deployed: ${REMOTE_DIR}"
          REMOTE_EOF
