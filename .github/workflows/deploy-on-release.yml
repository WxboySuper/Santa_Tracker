name: Deploy Santa Tracker on Release (published)

# Deploy to VPS when a GitHub Release is published.
# Uses password SSH for immediate compatibility; swap to SSH keys later.
on:
  release:
    types: [published]

permissions:
  contents: read
  actions: write

env:
  PROD_DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
  PROD_DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
  PROD_DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
  PROD_SSH_PASSWORD: ${{ secrets.PROD_SSH_PASSWORD }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout release commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync util-linux

      - name: Build deployment-package
        env:
          PROD_DOTENV: ${{ secrets.PROD_DOTENV }}
        run: |
          set -euo pipefail
          mkdir -p deployment-package
          rsync -av --exclude='*.pyc' --exclude='__pycache__' --exclude='.env' --exclude='venv/' \
            ./src/ deployment-package/src/ || true
          cp requirements.txt deployment-package/ || true
          if [ -f alembic.ini ]; then cp alembic.ini deployment-package/ || true; fi
          if [ -d alembic ]; then rsync -av --delete alembic/ deployment-package/alembic/ || true; fi
          if [ -n "${PROD_DOTENV:-}" ]; then
            printf '%s\n' "${PROD_DOTENV}" > deployment-package/.env
          else
            cat > deployment-package/.env <<EOF
          # Minimal defaults; add repository secrets for production values
          DATA_PATH=${PROD_DEPLOY_PATH}/data
          LOG_LEVEL=INFO
          EOF
          fi
          chmod 600 deployment-package/.env

      - name: Upload and finalize deploy
        run: |
          set -euo pipefail
          RELEASE_ROOT="${PROD_DEPLOY_PATH}/releases"
          TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
          REMOTE_DIR="${RELEASE_ROOT}/${TIMESTAMP}"
          sshpass -p "${PROD_SSH_PASSWORD}" ssh -o StrictHostKeyChecking=no \
            ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST} "mkdir -p '${REMOTE_DIR}'"
          rsync -avz --delete -e "sshpass -p '${PROD_SSH_PASSWORD}' ssh -o StrictHostKeyChecking=no" \
            deployment-package/ ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST}:"${REMOTE_DIR}/"
          sshpass -p "${PROD_SSH_PASSWORD}" ssh -o StrictHostKeyChecking=no \
            ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST} \
            "bash -s" <<EOF
          set -euo pipefail
          REMOTE_DIR="${REMOTE_DIR}"
          PROD_DEPLOY_PATH="${PROD_DEPLOY_PATH}"
          # create venv, install requirements, migrations, symlink, restart systemd
          python3 -m venv "${REMOTE_DIR}/venv"
          "${REMOTE_DIR}/venv/bin/pip" install --upgrade pip setuptools wheel || true
          if [ -f "${REMOTE_DIR}/requirements.txt" ]; then
            "${REMOTE_DIR}/venv/bin/pip" install -r "${REMOTE_DIR}/requirements.txt" || true
          fi
          if [ -f "${REMOTE_DIR}/alembic.ini" ]; then
            if [ -f "${REMOTE_DIR}/.env" ]; then
              set -o allexport; source "${REMOTE_DIR}/.env"; set +o allexport
            fi
            (cd "${REMOTE_DIR}" && venv/bin/alembic upgrade head) || true
          fi
          ln -sfn "${REMOTE_DIR}" "${PROD_DEPLOY_PATH}/current"
          sudo chown -R ${PROD_DEPLOY_USER}:${PROD_DEPLOY_USER} "${REMOTE_DIR}" || true
          sudo systemctl daemon-reload || true
          sudo systemctl restart santa-tracker || true
          systemctl status santa-tracker --no-pager || true
          EOF